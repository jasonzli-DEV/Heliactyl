// Enderactyl v13 - Prisma Schema
// This schema is designed for SQLite by default but can be changed to PostgreSQL or MySQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER MODEL
// ============================================================================

model User {
  id                   String   @id @default(uuid())
  discordId            String   @unique
  username             String
  email                String?
  avatar               String?
  isAdmin              Boolean  @default(false)
  banned               Boolean  @default(false)
  banReason            String?
  banExpiresAt         DateTime? // Optional: ban expires at this date
  
  // Discord OAuth tokens
  discordAccessToken   String?
  discordRefreshToken  String?
  
  // Resources (total available)
  coins                Int      @default(0)
  ram                  Int      @default(1024)
  disk                 Int      @default(5120)
  cpu                  Int      @default(100)
  servers              Int      @default(1)
  databases            Int      @default(1)
  backups              Int      @default(1)
  allocations          Int      @default(1)
  
  // Pterodactyl account link
  pterodactylId        Int?
  
  // AFK tracking
  lastAfkClaim         DateTime?
  
  // Timestamps
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  lastLogin            DateTime?
  
  // IP tracking
  registrationIp       String?
  lastIp               String?
  
  // Relations
  ownedServers         Server[]
  couponsUsed          CouponUse[]
  transactions         Transaction[]
  sessions             Session[]
  tickets              Ticket[]
  ticketMessages       TicketMessage[]
  statusEarn           StatusEarn?
  
  @@index([discordId])
}

// ============================================================================
// SERVER MODEL
// ============================================================================

model Server {
  id              String    @id @default(uuid())
  pterodactylId   Int       @unique
  pterodactylUuid String?
  name            String
  
  // Resources allocated to this server
  ram             Int
  disk            Int
  cpu             Int
  databases       Int       @default(1)
  backups         Int       @default(1)
  allocations     Int       @default(1)
  
  // Owner
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Location & Egg
  locationId      String
  location        Location  @relation(fields: [locationId], references: [id])
  eggId           String
  egg             Egg       @relation(fields: [eggId], references: [id])
  
  // Renewal
  renewalDate     DateTime?
  suspended       Boolean   @default(false)
  suspendedAt     DateTime?
  paused          Boolean   @default(false)
  
  // Billing tracking
  lastBilledAt    DateTime  @default(now())  // Last time server was billed
  billingBalance  Float     @default(0)      // Accumulated hourly cost owed
  nextBillingAt   DateTime?                  // When prepaid hour expires (null if paused)
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([userId])
  @@index([pterodactylId])
}

// ============================================================================
// SETTINGS MODEL
// ============================================================================

model Settings {
  id                    String   @id @default("main")
  
  // Site branding
  siteName              String   @default("Enderactyl")
  siteUrl               String?
  siteDescription       String?
  logo                  String?
  favicon               String?
  theme                 String   @default("dark")
  accentColor           String   @default("#6366f1")
  
  // Feature flags
  allowNewUsers         Boolean  @default(true)
  maintenanceMode       Boolean  @default(false)
  maintenanceMessage    String?
  footerText            String?  @default("Â© EnderBit Hosting 2025")
  
  // Discord
  discordInvite         String?
  
  // Pterodactyl connection
  pterodactylUrl        String?
  pterodactylApiKey     String?
  pterodactylKey        String?
  
  // Discord OAuth
  discordClientId       String?
  discordClientSecret   String?
  discordRedirectUri    String?
  
  // Admin
  adminDiscordId        String?
  
  // Secrets (auto-generated)
  jwtSecret             String?
  sessionSecret         String?
  
  // Default resources for new users
  defaultCoins          Int      @default(100)
  defaultRam            Int      @default(1024)
  defaultDisk           Int      @default(5120)
  defaultCpu            Int      @default(100)
  defaultServers        Int      @default(1)
  defaultDatabases      Int      @default(1)
  defaultBackups        Int      @default(1)
  defaultAllocations    Int      @default(1)
  
  // AFK settings (deprecated - use earn)
  afkEnabled            Boolean  @default(true)
  afkCoins              Int      @default(1)
  afkCoinsPerMinute     Int      @default(1)
  afkMaxMinutes         Int      @default(60)
  afkInterval           Int      @default(60)
  
  // Earn settings (Cuty.io style link earning)
  earnEnabled           Boolean  @default(true)
  earnCoins             Int      @default(10)    // Coins per earn
  earnCooldown          Int      @default(300)   // Cooldown in seconds (5 min default)
  cutyApiToken          String?  // Cuty.io API token for quick links
  
  // Discord Status Earn settings
  discordBotToken       String?                  // Discord bot token for status checking
  discordGuildId        String?                  // Discord server ID user must be in
  statusEarnEnabled     Boolean  @default(false) // Enable status earning
  statusEarnText        String?                  // Required text in Discord status
  statusEarnCoins       Int      @default(5)     // Coins awarded per interval
  statusEarnInterval    Int      @default(300)   // Interval in seconds (5 min default)
  
  // Store settings
  storeEnabled          Boolean  @default(true)
  ramPrice              Int      @default(10)
  diskPrice             Int      @default(10)
  cpuPrice              Int      @default(20)
  serverPrice           Int      @default(100)
  
  // Hourly billing settings (MB/% of resource per coin per hour)
  billingEnabled        Boolean  @default(false)  // Enable hourly billing
  billingRamRate        Float    @default(1024)   // MB RAM per coin/hour (1024 = 1GB costs 1 coin/hr)
  billingCpuRate        Float    @default(100)    // % CPU per coin/hour (100 = 100% costs 1 coin/hr)
  billingDiskRate       Float    @default(5120)   // MB disk per coin/hour (5120 = 5GB costs 1 coin/hr)
  billingDatabaseRate   Float    @default(0)      // Not used - databases are permanent
  billingAllocationRate Float    @default(0)      // Not used - allocations are permanent
  billingBackupRate     Float    @default(0)      // Not used - backups are permanent
  billingGracePeriod    Int      @default(24)     // Hours before suspension
  
  // Slider maximums for server creation
  maxRamSlider          Int      @default(12288)  // Max RAM in MB (12GB)
  maxDiskSlider         Int      @default(51200)  // Max Disk in MB (50GB)
  maxCpuSlider          Int      @default(400)    // Max CPU percentage
  
  // Timestamps
  updatedAt             DateTime @updatedAt
}

// ============================================================================
// PACKAGE MODEL
// ============================================================================

model Package {
  id            String   @id @default(uuid())
  name          String   @unique
  displayName   String
  description   String?
  enabled       Boolean  @default(true)
  
  // Resources included
  ram           Int      @default(1024)
  disk          Int      @default(5120)
  cpu           Int      @default(100)
  servers       Int      @default(1)
  databases     Int      @default(1)
  backups       Int      @default(1)
  allocations   Int      @default(1)
  
  // Pricing (coins)
  price         Int      @default(0)
  
  // Order for display
  sortOrder     Int      @default(0)
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ============================================================================
// LOCATION MODEL
// ============================================================================

model Location {
  id              String    @id @default(uuid())
  pterodactylId   Int       @unique
  name            String
  description     String?
  enabled         Boolean   @default(true)
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  servers         Server[]
}

// ============================================================================
// EGG MODEL
// ============================================================================

model Egg {
  id              String    @id @default(uuid())
  pterodactylId   Int
  nestId          Int
  nestName        String    @default("Unknown")
  nestEnabled     Boolean   @default(true)
  name            String
  displayName     String
  description     String?
  enabled         Boolean   @default(true)
  
  // Resource requirements
  minRam          Int       @default(512)
  minDisk         Int       @default(512)
  minCpu          Int       @default(50)
  
  // Resource maximums (null = unlimited)
  maxRam          Int?
  maxDisk         Int?
  maxCpu          Int?
  
  // Pterodactyl config
  dockerImage     String
  startup         String
  environment     String    @default("{}")
  
  // Feature limits
  databases       Int       @default(1)
  backups         Int       @default(1)
  allocations     Int       @default(1)
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  servers         Server[]
  
  @@unique([pterodactylId, nestId])
}

// ============================================================================
// COUPON MODEL
// ============================================================================

model Coupon {
  id            String      @id @default(uuid())
  code          String      @unique
  enabled       Boolean     @default(true)
  
  // Resources given
  coins         Int         @default(0)
  ram           Int         @default(0)
  disk          Int         @default(0)
  cpu           Int         @default(0)
  servers       Int         @default(0)
  databases     Int         @default(0)
  backups       Int         @default(0)
  allocations   Int         @default(0)
  
  // Usage limits
  maxUses       Int?
  usesCount     Int         @default(0)
  
  // Expiration
  expiresAt     DateTime?
  
  // Timestamps
  createdAt     DateTime    @default(now())
  
  // Relations
  uses          CouponUse[]
  
  @@index([code])
}

model CouponUse {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  couponId  String
  coupon    Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)
  usedAt    DateTime @default(now())
  
  @@unique([userId, couponId])
}

// ============================================================================
// TRANSACTION MODEL
// ============================================================================

model Transaction {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        String   // PURCHASE, COUPON, AFK, ADMIN_GRANT, etc.
  amount      Int      // Positive or negative
  description String?
  metadata    String?  // JSON string for extra data
  
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([type])
}

// ============================================================================
// SESSION MODEL
// ============================================================================

model Session {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  token     String   @unique
  expiresAt DateTime
  
  ipAddress String?
  userAgent String?
  
  createdAt DateTime @default(now())
  
  @@index([token])
  @@index([userId])
}

// ============================================================================
// AUDIT LOG MODEL
// ============================================================================

model AuditLog {
  id          String   @id @default(uuid())
  
  userId      String?
  action      String
  details     String?
  ipAddress   String?
  
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([action])
}

// ============================================================================
// EARN TOKEN MODEL (for one-time Cuty.io links)
// ============================================================================

model EarnToken {
  id          String   @id @default(uuid())
  token       String   @unique
  userId      String
  coins       Int
  claimed     Boolean  @default(false)
  expiresAt   DateTime
  
  createdAt   DateTime @default(now())
  claimedAt   DateTime?
  
  @@index([token])
  @@index([userId])
}

// ============================================================================
// STATUS EARN MODEL (for Discord status earning)
// ============================================================================

model StatusEarn {
  id             String    @id @default(uuid())
  userId         String    @unique  // One entry per user
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  enabled        Boolean   @default(true)  // User has activated status earning
  lastChecked    DateTime?                 // Last time we checked their status
  lastRewarded   DateTime?                 // Last time they received coins
  consecutiveSec Int       @default(0)     // Consecutive seconds with valid status
  
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  
  @@index([enabled])
}

// ============================================================================
// TICKET SYSTEM MODELS
// ============================================================================

model Ticket {
  id          String          @id @default(uuid())
  userId      String
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  subject     String
  status      String          @default("open") // open, closed
  priority    String          @default("normal") // low, normal, high
  type        String          @default("support") // support, ban-appeal
  
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  closedAt    DateTime?
  
  messages    TicketMessage[]
  
  @@index([userId])
  @@index([status])
  @@index([type])
}

model TicketMessage {
  id          String   @id @default(uuid())
  ticketId    String
  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  isStaff     Boolean  @default(false)
  message     String
  
  createdAt   DateTime @default(now())
  
  @@index([ticketId])
  @@index([userId])
}
